<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø§Ø³Ø® Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª ğŸ“±</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #eef2f3; padding: 20px; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: #fff; padding: 30px; border-radius: 15px; width: 100%; max-width: 450px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; margin-top: 0; }
        label { font-weight: bold; margin-bottom: 5px; display: block; color: #555; }
        input { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 15px; }
        button { width: 100%; padding: 14px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; transition: 0.3s; }
        button:hover { background: #0056b3; }
        
        /* Ù‚Ø³Ù… Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙˆØ§Ù„Ø®Ø·ÙˆØ§Øª */
        #progressSection { display: none; margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; border: 1px solid #ddd; }
        .step { margin: 10px 0; color: #666; font-size: 14px; display: flex; align-items: center; }
        .step.active { color: #007bff; font-weight: bold; }
        .step.done { color: #28a745; text-decoration: line-through; }
        .spinner { margin-left: 10px; border: 3px solid #f3f3f3; border-top: 3px solid #007bff; border-radius: 50%; width: 15px; height: 15px; animation: spin 1s linear infinite; display: none; }
        .step.active .spinner { display: inline-block; }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ */
        #timeContainer { text-align: center; margin-top: 15px; font-weight: bold; color: #d35400; }
        
        /* Ù‚Ø³Ù… Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ ÙˆØ§Ù„Ù†Ø¬Ø§Ø­ */
        #alertBox { display: none; margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; font-weight: bold; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ“± Ù†Ø§Ø³Ø® Ø§Ù„Ù€ APK</h2>
        <form id="clonerForm">
            <label>Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (APK):</label>
            <input type="file" id="apkFile" accept=".apk" required>
            
            <label>Ø§Ø³Ù… Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯:</label>
            <input type="text" id="appName" placeholder="Ù…Ø«Ø§Ù„: Ù†Ø³Ø®ØªÙŠ" required>
            
            <label>Ø§Ø³Ù… Ø§Ù„Ø­Ø²Ù…Ø© (Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹):</label>
            <input type="text" id="pkgName" placeholder="Ù…Ø«Ø§Ù„: com.ahmed.app" required pattern="^[a-zA-Z][a-zA-Z0-9_]*(\.[a-zA-Z][a-zA-Z0-9_]*)+$" title="Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø¨Ø§Ù„Ø´ÙƒÙ„ Ø¯Ù‡: com.name.app">
            
            <button type="submit" id="submitBtn">ğŸš€ Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù†Ø³Ø®</button>
        </form>

        <div id="progressSection">
            <div class="step" id="step1">1. Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù ÙˆÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ± <div class="spinner"></div></div>
            <div class="step" id="step2">2. ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø²Ù…Ø© <div class="spinner"></div></div>
            <div class="step" id="step3">3. Ø¥Ø¹Ø§Ø¯Ø© ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ù€ APK (ÙŠØ³ØªØºØ±Ù‚ ÙˆÙ‚ØªØ§Ù‹) <div class="spinner"></div></div>
            <div class="step" id="step4">4. ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ <div class="spinner"></div></div>
            
            <div id="timeContainer">â³ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù‚Ø¯Ø± Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: <span id="timeLeft">90</span> Ø«Ø§Ù†ÙŠØ©</div>
        </div>

        <div id="alertBox"></div>
    </div>

    <script>
        let timerInterval;

        document.getElementById("clonerForm").addEventListener("submit", async function(e) {
            e.preventDefault();
            
            // ØªØµÙÙŠØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            document.getElementById("submitBtn").style.display = 'none';
            document.getElementById("progressSection").style.display = 'block';
            document.getElementById("alertBox").style.display = 'none';
            document.getElementById("alertBox").className = '';
            
            let steps = [
                document.getElementById("step1"),
                document.getElementById("step2"),
                document.getElementById("step3"),
                document.getElementById("step4")
            ];
            steps.forEach(s => s.className = 'step'); // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ù„Ù„ÙˆÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠ

            // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø¯Ø§Ø¯ (90 Ø«Ø§Ù†ÙŠØ© ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù†Ø³Ø®)
            let timeLeft = 90;
            document.getElementById("timeLeft").innerText = timeLeft;
            clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                if(timeLeft > 0) {
                    timeLeft--;
                    document.getElementById("timeLeft").innerText = timeLeft;
                    
                    // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙˆÙ‚Øª (ÙˆÙ‡Ù…ÙŠ Ù„Ù„ØªÙØ§Ø¹Ù„)
                    if(timeLeft == 85) updateSteps(steps, 0); // ÙÙƒ Ø§Ù„ØªØ´ÙÙŠØ±
                    if(timeLeft == 70) updateSteps(steps, 1); // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø²Ù…Ø©
                    if(timeLeft == 65) updateSteps(steps, 2); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹ (Ø£Ø·ÙˆÙ„ Ø®Ø·ÙˆØ©)
                    if(timeLeft == 15) updateSteps(steps, 3); // Ø§Ù„ØªÙˆÙ‚ÙŠØ¹
                }
            }, 1000);

            // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            let formData = new FormData();
            formData.append("apkFile", document.getElementById("apkFile").files[0]);
            formData.append("appName", document.getElementById("appName").value);
            formData.append("pkgName", document.getElementById("pkgName").value.trim());

            try {
                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ±
                let response = await fetch('/clone', { method: 'POST', body: formData });
                
                clearInterval(timerInterval); // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ø¯Ø§Ø¯
                document.getElementById("progressSection").style.display = 'none'; // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø®Ø·ÙˆØ§Øª
                
                if (response.ok) {
                    // Ø§Ù„Ù†Ø¬Ø§Ø­ ÙˆØ§Ù„ØªØ­Ù…ÙŠÙ„
                    let blob = await response.blob();
                    let link = document.createElement('a');
                    link.href = window.URL.createObjectURL(blob);
                    link.download = document.getElementById("appName").value + '.apk';
                    link.click();
                    
                    showAlert("âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.", "success");
                } else {
                    // Ù„Ùˆ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø¨Ø¹Øª Ø®Ø·Ø£ (Ø²ÙŠ Ù…Ø³Ø§Ø­Ø© ÙƒØ¨ÙŠØ±Ø© Ø£Ùˆ Ø§Ø³Ù… Ø­Ø²Ù…Ø© ØºÙ„Ø·)
                    let errorText = await response.text();
                    showAlert("âŒ ÙØ´Ù„ Ø§Ù„Ù†Ø³Ø®: " + errorText, "error");
                }
            } catch (err) {
                clearInterval(timerInterval);
                document.getElementById("progressSection").style.display = 'none';
                showAlert("âŒ Ø­ØµÙ„ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. (ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø´ØºØ§Ù„)", "error");
            }

            // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø²Ø±Ø§Ø±
            document.getElementById("submitBtn").style.display = 'block';
        });

        // Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø®Ø·ÙˆØ§Øª
        function updateSteps(steps, activeIndex) {
            steps.forEach((step, index) => {
                if (index < activeIndex) step.className = 'step done';
                else if (index === activeIndex) step.className = 'step active';
                else step.className = 'step';
            });
        }

        // Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function showAlert(message, type) {
            let box = document.getElementById("alertBox");
            box.innerText = message;
            box.className = type;
            box.style.display = 'block';
        }
    </script>
</body>
</html>
